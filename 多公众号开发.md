## 多公众号开发
这里主要指的是，一个系统，需要对接多个公众号，共用同一个数据库。  
- 公众号认证信息需要存储到数据库中  
- 请求过来的时候，需要能识别出是哪个公众号  

第一点，大部分库都有解决方案。这里不强调。  

第二点，一开始我的思路是，在请求参数中带上公众号的唯一id，微信官方叫原始id，于是我起名`originId`。  

这样是行的通的。不过有很多问题：  
- 每个请求都要带上这个参数。不管是`GET`还是`POST`  
- 后端要有一个统一的获取这个参数的地方。判断麻烦  
- 前端写代码的时候很容易忘记要带上这个参数，然后会莫名其妙调试很久  
- 前端如果要保存`Cookie`或`localStorage`，那每个`key`要带`originId`的值  

后来，我想了个办法：通过域名来解决。  
即，把`originId`作为四级域名。比如你的域名是`app.domain.com`，那么在`app`前面再加一级。  

但是`originId`的原始值带了`_`，貌似域名中不能有。  

另外，出于特殊性，对`originId`做了处理，把`gh_`给改为一个特殊的前缀，比如`xxxx`。  
所以第四级域名就是：`xxxxYYYYYYYYY`，其中`YYYYYYYYY`是`originId`去掉`gh_`后的部分。  

后端在统一入口处，判断`host`是否以`xxxx`开头。如果是，那么确定就是一个`originId`，这时候可以把值写到逻辑代码中容易访问的地方。  
比如我们系统是`nodejs`，我写在了`request header`。在逻辑代码中可以`header.originId`，即可拿到。  


这样解决了前端`Cookie`的问题。每个公众号对应一个域名，独立`Cookie`。  

只是在配置DNS解析的地方，要为每个公众号域名添加一条解析。  

在应用服务器的`nginx`配置中，`server_name`要添加`*.app.domain.com`值。  

这样就完成了多公众号共用同一个应用的方案。
